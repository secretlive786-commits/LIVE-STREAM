name: Video + Audio Stream (Loop & AI Bot)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [restart_stream]

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 358 

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install FFmpeg & AI Libraries
        run: |
          sudo apt update
          sudo apt install -y ffmpeg
          # Yahan requirement wala text direct install ho raha hai
          pip install google-generativeai==0.8.3 pytchat==0.5.5 requests

      - name: Start Live Stream and AI Bot
        env:
          STREAM_URL: "rtmp://a.rtmp.youtube.com/live2/k4bv-wakv-50ad-uas6-8rtr"
          GH_TOKEN: ${{ secrets.GH_PAT }}
          GEMINI_KEY: ${{ secrets.GEMINI_KEY }}
          YT_API_KEY: ${{ secrets.YT_API_KEY }}
        run: |
          echo "AI Bot starting in background..."
          # nohup se bot "End" nahi hoga aur background mein chalta rahega
          nohup python ai_bot.py > bot_logs.txt 2>&1 & 
          
          echo "Streaming starting with Copyright Protection..."
          # FFmpeg with Pitch/Speed protection
          ffmpeg -re \
            -stream_loop -1 -i video.mp4 \
            -stream_loop -1 -i audio.mp3 \
            -filter_complex "[1:a]atempo=1.02,asetrate=44100*1.02,aresample=44100[aout]" \
            -map 0:v:0 -map "[aout]" \
            -c:v libx264 \
            -preset veryfast \
            -pix_fmt yuv420p \
            -g 50 \
            -b:v 2000k \
            -c:a aac \
            -b:a 128k \
            -t 05:50:00 \
            -f flv \
            "$STREAM_URL"

          echo "FFmpeg finished. Triggering next workflow..."
          curl -X POST \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type": "restart_stream"}'
